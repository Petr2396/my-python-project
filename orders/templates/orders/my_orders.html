{% extends "base.html" %}
{% block title %}–ú–æ–∏ –∑–∞–∫–∞–∑—ã{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>

    <ul class="nav nav-tabs" id="ordersTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button">
                –¢–µ–∫—É—â–∏–µ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="archived-tab" data-bs-toggle="tab" data-bs-target="#archived" type="button">
                –ê—Ä—Ö–∏–≤–Ω—ã–µ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="returns-tab" data-bs-toggle="tab" data-bs-target="#returns" type="button">
                –í–æ–∑–≤—Ä–∞—Ç—ã
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="ordersTabsContent">
        <!-- üîπ –¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã -->
        <div class="tab-pane fade show active" id="active" role="tabpanel">
            {% if active_orders %}
                {% for order in active_orders %}
                    <div class="card mb-3 order-card">
                        <div class="card-header">
                            –ó–∞–∫–∞–∑ ‚Ññ{{ order.id }} –æ—Ç {{ order.created|date:"d.m.Y H:i" }}
                            <span class="badge 
                                {% if order.status == 'new' %} bg-primary
                                {% elif order.status == 'processing' %} bg-info text-dark
                                {% elif order.status == 'shipped' %} bg-warning text-dark
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                        <div class="card-body">
                            <ul>
                                {% for item in order.items.all %}
                                    <li>{{ item.product.name }} ‚Äî {{ item.quantity }} √ó {{ item.price }} ‚ÇΩ = {{ item.get_cost }} ‚ÇΩ</li>
                                {% endfor %}
                            </ul>

                            <!-- –ò—Ç–æ–≥ -->
                            <div class="order-summary mt-3 p-3 bg-light rounded">
                                <div class="d-flex justify-content-between">
                                    <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                    <span>{{ order.get_total_cost }} ‚ÇΩ</span>
                                </div>

                                {% if order.discount %}
                                <div class="d-flex justify-content-between text-success">
                                    <span>–°–∫–∏–¥–∫–∞ ({{ order.discount }}%):</span>
                                    <span>-{{ order.get_discount_amount }} ‚ÇΩ</span>
                                </div>
                                {% endif %}

                                <div class="d-flex justify-content-between total fw-bold mt-2 pt-2 border-top">
                                    <span>–ò—Ç–æ–≥–æ:</span>
                                    <span>
                                        {% if order.total_with_discount %}
                                            {{ order.total_with_discount }} ‚ÇΩ
                                        {% else %}
                                            {{ order.get_total_cost }} ‚ÇΩ
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            {% if order.status == "new" or order.status == "processing" %}
                            <form method="post" action="{% url 'orders:cancel_order' order.id %}" class="mt-3">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>
            {% endif %}
        </div>

        <!-- üîπ –ê—Ä—Ö–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
        <div class="tab-pane fade" id="archived" role="tabpanel">
            {% if archived_orders %}
                {% for order in archived_orders %}
                    <div class="card mb-3 border-secondary order-card">
                        <div class="card-header">
                            –ó–∞–∫–∞–∑ ‚Ññ{{ order.id }} –æ—Ç {{ order.created|date:"d.m.Y H:i" }}
                            <span class="badge 
                                {% if order.status == 'delivered' %} bg-success
                                {% elif order.status == 'canceled' %} bg-danger
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                        <div class="card-body">
                            <ul>
                                {% for item in order.items.all %}
                                    <li>{{ item.product.name }} ‚Äî {{ item.quantity }} √ó {{ item.price }} ‚ÇΩ = {{ item.get_cost }} ‚ÇΩ</li>
                                {% endfor %}
                            </ul>

                            <div class="order-summary mt-3 p-3 bg-light rounded">
                                <div class="d-flex justify-content-between">
                                    <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                    <span>{{ order.get_total_cost }} ‚ÇΩ</span>
                                </div>

                                {% if order.discount %}
                                <div class="d-flex justify-content-between text-success">
                                    <span>–°–∫–∏–¥–∫–∞ ({{ order.discount }}%):</span>
                                    <span>-{{ order.get_discount_amount }} ‚ÇΩ</span>
                                </div>
                                {% endif %}

                                <div class="d-flex justify-content-between total fw-bold mt-2 pt-2 border-top">
                                    <span>–ò—Ç–æ–≥–æ:</span>
                                    <span>
                                        {% if order.total_with_discount %}
                                            {{ order.total_with_discount }} ‚ÇΩ
                                        {% else %}
                                            {{ order.get_total_cost }} ‚ÇΩ
                                        {% endif %}
                                    </span>
                                </div>

                                <!-- üîπ –ö–ù–û–ü–ö–ê –í–û–ó–í–†–ê–¢–ê –° –ü–†–û–í–ï–†–ö–û–ô -->
                                {% if order.is_paid and order.status == "delivered" %}
    {% if order.can_create_return %}
        <a href="{% url 'orders:return_request' order.id %}" 
           class="btn btn-warning btn-sm mt-2">‚Ü∂ –í–µ—Ä–Ω—É—Ç—å —Ç–æ–≤–∞—Ä</a>
    {% else %}
        {% if order.has_return_request %}
            <button class="btn btn-secondary btn-sm mt-2" disabled>
                ‚è≥ –í–æ–∑–≤—Ä–∞—Ç —É–∂–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω
            </button>
        {% else %}
            <button class="btn btn-secondary btn-sm mt-2" disabled>
                ‚è≥ –°—Ä–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏—Å—Ç–µ–∫
            </button>
        {% endif %}
    {% endif %}
{% endif %}

                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>–ù–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>
            {% endif %}
        </div>

        <!-- üîπ –í–æ–∑–≤—Ä–∞—Ç—ã -->
        <div class="tab-pane fade" id="returns" role="tabpanel">
            {% if returns %}
                {% for ret in returns %}
                    <div class="card mb-3 border-info order-card">
                        <div class="card-header">
                            –í–æ–∑–≤—Ä–∞—Ç –ø–æ –∑–∞–∫–∞–∑—É ‚Ññ{{ ret.order.id }}
                            <span class="badge 
                                {% if ret.status == 'pending' %} bg-warning text-dark
                                {% elif ret.status == 'approved' %} bg-success
                                {% elif ret.status == 'rejected' %} bg-danger
                                {% endif %}">
                                {{ ret.get_status_display }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ ret.reason }}</p>
                            {% if ret.photo %}
                                <p><img src="{{ ret.photo.url }}" alt="–§–æ—Ç–æ" class="img-thumbnail" style="max-width:200px;"></p>
                            {% endif %}
                            <p><strong>–¢–æ–≤–∞—Ä—ã:</strong>
                                {% for item in ret.items.all %}
                                    {{ item.product.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            <p><small>–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: {{ ret.created_at|date:"d.m.Y H:i" }}</small></p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–æ–≤.</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
.order-card { border-radius: 12px; overflow: hidden; }
.order-summary { background: #f8f9fa; border: 1px solid #e9ecef; }
.summary-row.total { font-size: 18px; color: #ff6a00; }

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
.btn-secondary {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
}
</style>
{% endblock %}































































































